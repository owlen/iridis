<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <meta charset="utf-8">
        <title>Iridis Trader</title>
        <meta name="description" content="Iridis trading Web app">
        <style>
            #nojs{
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                background: yellow;
                color: red;
            }
            #log{
                width: 100%;
                background: yellow;
                color: black;
            }
        </style>
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script type="text/javascript">

var wallet = {
    red: {
        definition: 'obc:1737d32b3bfdd06a177435a00e4ddd8befe804daece3cfa19508f1ec7a2df2a9:0:241614',
        utxos: [
            {
                txid: '1737d32b3bfdd06a177435a00e4ddd8befe804daece3cfa19508f1ec7a2df2a9',
                vout: 0,
                scriptPubKey: '76a914701c51bae66dee0733e7da0e59eb85c3c7e4aba088ac'
            }
        ],
        addresses: [
            'mqjjuCJBBHx8qb6aUMLpr8BW1kgpBasxqW'
        ],
        prvkeys: [
            '93Pf466pBtm66oQDcf19NxK7PdNkGyNVrpMqz2xwGgUqwZyo51D'
        ]
    },
    blue: {
        definition: 'obc:f9931ace552776defae1114f551cfb09a6453f13956e042e8d78a8fd42af804b:0:241616',
        utxos: [
            {
                txid: 'f9931ace552776defae1114f551cfb09a6453f13956e042e8d78a8fd42af804b',
                vout: 0,
                scriptPubKey: '76a91418d1a2a45606ab1df27385db5a567c3776870fe388ac'
            }
        ],
        addresses: [
            'mhnBeNiuiQtkaPVaBUYkx6L3oAmboxjiZc'
        ],
        prvkeys: [
            '92uLoBbJMvYKZtXPNLgG5n4MsbMJjMxJ1x1z4H5BtTJG1MYPJ19'
        ]
    },
    GLD: {
        definition: 'obc:b2e2fe91385b66b413d23d00c45d2958c273ba6248c2a5da0d3738ccffef74e9:0:242505',
        utxos: [
            {
                txid: '0c6364e2e35b8bee769225f90d992771ff1bc2b868fa388b085456261fb521ee',
                vout: 0,
                scriptPubKey: '76a914cbf3f79259766fe34014363760c49049e9c1c18d88ac'
            }
        ],
        addresses: [
            'mz7Mj8DfMscv9zkUCCxDsnGaC8Q73bASE8'
        ],
        prvkeys: [
            '93AVMYk31219YwyjGGeyRaq91ybVsTKpprH1WHdU6My2ADnFgD7'
        ]
    },
    SLV: {
        definition: 'obc:ebf6742cd705bfd3dbfb6470dadbf248a6cf90f4b54775ad54ce79ed45bd6365:0:242505',
        utxos: [
            {
                txid: 'beaccaf25accb9a4028ccd6bf2df3aa78b8557f42f91721e6267daa00b4d6879',
                vout:  0,
                scriptPubKey: '76a9140ad64c38b0c229ad040f8b2ad50ef7bddba1d0d588ac'
            }
        ],
        addresses: [
            'mgWFme6LrUZdAaE7xMvE6hyL85DzkccCrF'
        ],
        prvkeys: [
            '93U3qiBeRuKKvcq6EgtQNNeDVsxhq8RWXHxG71W3EstesTquoQT'
        ]
    }
};

var filter = {
    'give': {
        'definition': wallet.SLV.definition,
        'quantity': 500,
        'utxos': wallet.SLV.utxos
    },
    'take': {
        'definition': wallet.GLD.definition,
        'quantity': 10,
        'address': wallet.GLD.addresses[0]
    }
};

function log(msg){
    console.log(arguments);
    if('string' === typeof msg) $('#log').prepend($('<div>').text(msg));
};

function jsonp(method, data, callback){
    $.ajax({
        url: method + '.jsonp',
        dataType: 'jsonp',
        type: 'GET',
        data: data,
        success:function(data){
            if(null !== data && 'string' === typeof data.error) log(data.error, arguments);
            callback(data);
        },
        error:function(){
            log('Unable to retrieve ' + method, arguments);
        }
    });
};

function scancolor(color, callback){
    if('number' !== typeof(color.checking)) color.checking = 0;
    else if(0 < color.checking) return false;
    color.value = 0;
    $.each(color.utxos, function(i, utxo){
        color.checking++;
        jsonp('colorvalue', {'colordef': color.definition, 'txo': [utxo.txid, utxo.vout]}, function(value){
            color.value += value;
            if(0 === --color.checking) callback(color);
        });
    });
}

function scanwallet(colors){
    $.each(colors, function(colorname, color){
        color.name = colorname;
        scancolor(color, function(color){
            if(0 === color.checking) log('you have ' + color.value + ' ' + color.name);
        });
    });
}

function txotolist(txo){
    return [txo.txid, txo.vout];
}

function fulfilproposal(proposal){
    $('<button>').text('Bob: fulfil proposal').click(function(e){
        $(e.target).remove();
        proposal.spec = {};
        proposal.spec.inputs = {};
        proposal.spec.inputs[proposal.give.definition] = [$.map(proposal.give.utxos, txotolist)];
        proposal.spec.inputs[wallet.SLV.definition] = [$.map(wallet.SLV.utxos, txotolist)];
        proposal.spec.targets = [
            [
                proposal.take.address,
                proposal.take.definition,
                proposal.take.quantity
            ], [
                wallet.GLD.addresses[0],
                wallet.GLD.definition,
                10
            ]
        ];
        jsonp('makeconversion', {'txspec': JSON.stringify(proposal.spec)}, function(hex){
            var inputs = []
            $.each(wallet.SLV.utxos, function(i, utxo){
                inputs.push({'txid': utxo.txid, 'vout': utxo.vout, 'scriptPubKey': utxo.scriptPubKey})
            });
            jsonp('signrawtransaction', {'rawtx': hex, 'inputs': JSON.stringify(inputs), 'keys': wallet.SLV.prvkeys}, function(tx){
                log((tx.complete ? 'completely' : 'partially') + ' signed: ' + tx.hex, tx);
                jsonp('send', {'subject': 'fulfil', 'body': tx.hex}, function(){ log('Fulfil sent'); });
            });
        });
    }).appendTo($('#content'));
}

function filterproposal(filter, proposal){
    if(filter.give.definition !== proposal.take.definition) return false;
    if(filter.take.definition !== proposal.give.definition) return false;
    if(
        filter.give.quantity / filter.take.quantity <
        proposal.take.quantity / proposal.give.quantity
    ) return false;

    scancolor(proposal.give, function(color){
        if(proposal.give.quantity > color.value) return false;
        fulfilproposal(proposal);
    });
}

function getmessages(){
    jsonp('receive', {}, function(messages){
        $.each(messages, function(i, message){
            if('proposal' === message.subject){
                filterproposal(filter, message.body);
            }else if('fulfil' === message.subject){
                var inputs = []
                $.each(wallet.SLV.utxos, function(i, utxo){
                    inputs.push({'txid': utxo.txid, 'vout': utxo.vout, 'scriptPubKey': utxo.scriptPubKey})
                });
                jsonp('signrawtransaction', {'rawtx': message.body, 'inputs': JSON.stringify(inputs), 'keys': wallet.SLV.prvkeys}, function(tx){
                    log((tx.complete ? 'completely' : 'partially') + ' signed: ' + tx.hex, tx);
                });
            }
            log('received: ' + message.subject, message);
        });
        setTimeout('getmessages()', 1000);
    });
}

$(function(){
    $('#nojs').remove();
    log('js detected');
    scanwallet(wallet);
    getmessages();
    $('<button>').text('Alice: send proposal').click(function(){
        jsonp('send', {'subject': 'proposal', 'body': JSON.stringify(filter)}, function(){ log('Proposal sent'); });
    }).appendTo($('#content'));
});

        </script>
    </head>
    <body>
        <div id="nojs">Either you have JavaScript disabled, or we have a serious bug.</div>
        <div id="content"></div>
        <div id="log"></div>
    </body>
</html>
<!--
vim: ft=javascript
-->
